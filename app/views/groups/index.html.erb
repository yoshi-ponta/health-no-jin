<section class="container mx-auto max-w-screen-xl">
  <% if @group.nil? %>
    <h1 class="text-xl font-bold mb-4">グループ</h1>
    <div class="rounded-2xl border border-dashed p-8 text-center text-sm text-gray-500">
      参加中のグループはありません
      <div class="mt-3">
        <%= link_to "グループを作成する", new_group_path, class: "underline" %>
      </div>
    </div>
  <% else %>
    <div class="mb-4 flex items-center justify-between">
      <h1 class="text-xl font-bold"><%= @group.name %> のメンバー</h1>

      <% if @group.owner_id == current_user.id && @group.invite_token.present? %>
        <details class="text-sm text-right">
          <summary class="cursor-pointer select-none text-gray-700">招待リンクを表示</summary>
          <div class="mt-1">
            <span class="font-mono break-all underline">
              <%= link_to invite_path(token: @group.invite_token),
                          invite_path(token: @group.invite_token) %>
            </span>
            <button
              type="button"
              data-copy="<%= invite_path(token: @group.invite_token) %>"
              onclick="(async (btn)=>{try{
                await navigator.clipboard.writeText(btn.dataset.copy);
                const old = btn.textContent; btn.textContent='コピーしました';
                setTimeout(()=>btn.textContent=old||'コピー',1500);
              }catch(e){
                prompt('コピーできない場合は手動でコピーしてください', btn.dataset.copy);
              }})(this)"
              class="btn btn-outline btn-sm ml-2"
            >コピー</button>
          </div>
        </details>
      <% end %>
    </div>

    <% if @members.blank? %>
      <div class="rounded-2xl border border-dashed p-8 text-center text-sm text-gray-500">
        メンバーがいません
      </div>
    <% else %>
      <ul class="space-y-2">
        <% @members.each do |membership| %>
          <% member_user = membership.user %>
          <% is_owner = (member_user.id == @group.owner_id) %>
          <% is_me    = (member_user.id == current_user.id) %>

          <li class="grid grid-cols-[auto,1fr,auto] items-center gap-3 rounded-2xl p-3 shadow-sm bg-white">
            <div class="min-w-0">
              <div class="text-sm font-medium truncate">
                <% display_name = member_user.name.presence || t(".display_name_fallback") %>
                <%= display_name %>
                <span class="ml-2 px-2 py-0.5 rounded-full text-xs bg-amber-100 text-amber-800 font-semibold align-middle">
                  <%= (@points_by_user[member_user.id] || 0) %> pt
                </span>
                <% if is_me %><span class="text-gray-500 text-xs">(あなた)</span><% end %>
              </div>
            </div>

            <div class="text-right space-y-1">
              <% if is_owner %>
                <span class="px-2 py-0.5 rounded-full text-xs bg-amber-100 text-amber-800 font-semibold">大将</span>
              <% end %>

              <% unless is_me %>
                <% cheered = Cheer.cheered_today?(group: @group, from_user: current_user, to_user: member_user) %>
                <% if cheered %>
                  <button class="btn btn-outline btn-xs" disabled>応援済み</button>
                <% else %>
                  <%= button_to "応援する",group_cheers_path(@group, to_user_id: member_user.id),method: :post,form: { data: { turbo: false } },class: "btn btn-primary btn-xs"%>
                <% end %>
              <% end %>
            </div>
          </li>
        <% end %>
      </ul>
    <% end %>
  <% end %>
</section>
